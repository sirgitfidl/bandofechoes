<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vote Photos — Band of Echoes</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="assets/css/main.css">
  <style>
    :root { --gap: 14px; }
    body { margin: 0; }
    header { border-bottom: 1px solid var(--border, #ccc); position: sticky; top: 0; backdrop-filter: blur(6px); background: color-mix(in srgb, Canvas 85%, transparent); z-index: 10; }
    header .wrap { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; max-width: 1100px; margin: 0 auto; }
    header a { text-decoration: none; }
    main { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin: 8px 0 16px; }
    .muted { opacity: .7; font-size: .95em; }
    .grid { display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .card { border: 1px solid var(--border, #ddd); border-radius: 8px; overflow: hidden; background: Canvas; box-shadow: 0 1px 2px color-mix(in srgb, #000 8%, transparent); display: flex; flex-direction: column; }
    .card img { width: 100%; height: 200px; object-fit: cover; display: block; background: #111; cursor: zoom-in; }
    .meta { padding: 10px; display: grid; gap: 8px; }
    .id { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .look { display: none; }
    .rate { display: flex; gap: 8px; align-items: center; justify-content: center; }
    .rate input { display: none; }
    .rate label { cursor: pointer; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border, #bbb); font-size: 14px; min-width: 38px; text-align: center; }
    .rate input:checked + label { background: #222; color: #fff; border-color: #222; }
    .sticky-footer { position: sticky; bottom: 0; margin-top: 16px; background: color-mix(in srgb, Canvas 90%, transparent); backdrop-filter: blur(6px); border-top: 1px solid var(--border, #ccc); }
    .sticky-footer .wrap { padding: 10px 16px; display: flex; gap: 10px; align-items: center; justify-content: space-between; max-width: 1100px; margin: 0 auto; }
    .btn { padding: 8px 12px; border: 1px solid var(--border, #ccc); border-radius: 6px; background: ButtonFace; cursor: pointer; }
    .btn.primary { background: #222; color: #fff; border-color: #222; }
    .section-title { margin: 8px 0 14px; }
    .results-note { margin: 10px 0 16px; }
    .hidden { display: none !important; }
    .lb { position: fixed; inset: 0; background: rgba(0,0,0,.9); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 32px 56px; }
    .lb:not(.hidden) { display: flex; }
    .lb .content { display: flex; flex-direction: column; align-items: center; gap: 14px; max-width: 96vw; max-height: 92vh; }
    .lb img { max-width: 96vw; max-height: calc(92vh - 120px); object-fit: contain; background: #000; border-radius: 8px; margin: 0 auto; }
    .lb .lb-id { color: #fff; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; opacity: .9; text-align: center; }
    .lb .lb-rate { display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap; }
    .lb .lb-rate input { display: none; }
    .lb .lb-rate label { cursor: pointer; padding: 10px 14px; border-radius: 8px; border: 1px solid #aaa; color: #fff; font-size: 18px; min-width: 54px; text-align: center; }
    .lb .lb-rate input:checked + label { background: #fff; color: #000; border-color: #fff; }
    .lb .lb-close { position: absolute; top: 12px; right: 14px; background: transparent; color: #fff; border: 0; font-size: 28px; cursor: pointer; }
    .lb .lb-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,.12); color: #fff; border: 1px solid rgba(255,255,255,.4); width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 22px; display: grid; place-items: center; }
    .lb .lb-arrow.prev { left: 10px; }
    .lb .lb-arrow.next { right: 10px; }
    .counts { font-size: 12px; opacity: .75; }
    .lb .lb-counts { color: #ddd; font-size: 14px; }
  </style>
</head>
<body>
  <a href="#main" class="skip">Skip to content</a>
  <header>
    <div class="wrap">
      <div>
        <strong>Band of Echoes</strong> · Photo voting
      </div>
      <nav>
        <a href="./" class="muted">← Back to home</a>
      </nav>
    </div>
  </header>
  <main id="main">
    <h1 class="section-title">Vote on photos</h1>
    <p class="muted">Rate each image with ✓ or ✕. When you submit, your picks will be shown with Yes first.</p>
    <div class="controls">
      <span class="muted" id="progress">0 decided</span>
    </div>
    <section id="voteView">
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
    <section id="resultsView" class="hidden">
      <h2 class="section-title">Results</h2>
      <p class="muted results-note" id="resultsNote"></p>
      <div id="resultsGrid" class="grid"></div>
    </section>
  </main>
  <!-- Full-size lightbox -->
  <div id="lightbox" class="lb hidden" role="dialog" aria-modal="true" aria-label="Image viewer">
    <button class="lb-close" id="lbClose" aria-label="Close">×</button>
    <button class="lb-arrow prev" id="lbPrev" aria-label="Previous">‹</button>
    <div class="content">
      <img id="lbImg" alt="">
      <div class="lb-rate" id="lbRate" role="radiogroup"></div>
      <div class="lb-id" id="lbId"></div>
    </div>
    <button class="lb-arrow next" id="lbNext" aria-label="Next">›</button>
  </div>
  <div class="sticky-footer">
    <div class="wrap">
      <div class="muted">Your votes are saved locally.</div>
      <div style="display:flex; gap:8px;">
        <button id="resetBtn" class="btn" type="button">Reset</button>
        <button id="submitBtn" class="btn primary" type="button">Submit votes</button>
      </div>
    </div>
  </div>
  <!-- Optional: Firebase config and remote vote aggregation -->
  <script src="assets/js/firebase-config.js"></script>
  <script type="module" src="assets/js/remote-votes.js"></script>
  <!-- Photo data generated by scrape-smugmug.js -->
  <script src="assets/js/data/bofe-photos.js" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      (function() {
        const LS_KEY = 'bofe-votes-v1';
        const photos = (window.BOE_PHOTOS || []).slice();

        const grid = document.getElementById('grid');
        const resultsGrid = document.getElementById('resultsGrid');
        const voteView = document.getElementById('voteView');
        const resultsView = document.getElementById('resultsView');
        const submitBtn = document.getElementById('submitBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progress = document.getElementById('progress');
        const resultsNote = document.getElementById('resultsNote');

        // Lightbox
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lbImg');
        const lbId = document.getElementById('lbId');
        const lbRate = document.getElementById('lbRate');
        const lbClose = document.getElementById('lbClose');
        const lbPrev = document.getElementById('lbPrev');
        const lbNext = document.getElementById('lbNext');
        let lbCountsEl = document.getElementById('lbCounts');
        if (!lbCountsEl) { lbCountsEl = document.createElement('div'); lbCountsEl.id = 'lbCounts'; lbCountsEl.className = 'lb-counts'; lbRate.parentElement.insertBefore(lbCountsEl, lbId); }

        let currentItems = [];
        let currentIndex = -1;
        let resultsOpen = false;

        function loadVotes() { try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch { return {}; } }
        function saveVotes(v) { localStorage.setItem(LS_KEY, JSON.stringify(v)); }
        let votes = loadVotes();

        function isDecided(v) { return v === 'yes' || v === 'no' || (typeof v === 'number' && !Number.isNaN(v)); }
        function isYes(v) { return v === 'yes' || (typeof v === 'number' && v >= 3); }

        // Remote counts and optimistic updates
        let remoteCounts = {}; // { [id]: { yes, no } }
        function ensureCount(id) { if (!remoteCounts[id]) remoteCounts[id] = { yes: 0, no: 0 }; return remoteCounts[id]; }
        function applyCountDelta(id, prev, next) {
          const c = ensureCount(id);
          if (prev === 'yes') c.yes = Math.max(0, (c.yes || 0) - 1);
          else if (prev === 'no') c.no = Math.max(0, (c.no || 0) - 1);
          if (next === 'yes') c.yes = (c.yes || 0) + 1;
          else if (next === 'no') c.no = (c.no || 0) + 1;
          updateCountsUIForId(id);
        }
        function getCountsFor(id) {
          const c = remoteCounts[id];
          if (c) return { yes: c.yes || 0, no: c.no || 0 };
          const v = votes[id];
          return isDecided(v) ? { yes: isYes(v) ? 1 : 0, no: isYes(v) ? 0 : 1 } : { yes: 0, no: 0 };
        }
        function updateCountsUIForId(id) {
          const c = getCountsFor(id);
          const gridEl = document.getElementById('counts-grid-' + id);
          if (gridEl) gridEl.textContent = `✓ ${c.yes} · ✕ ${c.no}`;
          const resEl = document.getElementById('counts-res-' + id);
          if (resEl) resEl.textContent = `✓ ${c.yes} · ✕ ${c.no}`;
          if (lbRate.dataset.forId === id && lbCountsEl) lbCountsEl.textContent = `✓ ${c.yes} · ✕ ${c.no}`;
        }
        function updateCountsUIAll() { currentItems.forEach(p => updateCountsUIForId(p.id)); if (resultsOpen) renderResults(); }

        async function fetchCountsFor(items) {
          if (!window.RemoteVotes) return;
          try {
            const ids = items.map(p => p.id);
            const data = await window.RemoteVotes.getCounts(ids);
            remoteCounts = { ...remoteCounts, ...data };
            updateCountsUIAll();
          } catch {}
        }
        function initRemoteSubscription() {
          if (!window.RemoteVotes || initRemoteSubscription._done) return;
          initRemoteSubscription._done = true;
          window.RemoteVotes.subscribeCounts((data) => {
            remoteCounts = { ...remoteCounts, ...data };
            updateCountsUIAll();
          });
        }

        function setVote(id, value) {
          const prev = votes[id] ?? null;
          votes[id] = value; // 'yes' | 'no'
          saveVotes(votes);
          updateProgress();
          syncVoteUI(id);
          applyCountDelta(id, prev, value); // optimistic
          if (window.RemoteVotes) {
            window.RemoteVotes.syncVote(id, prev, value).catch(() => {});
          }
        }

        function syncVoteUI(id) {
          const name = 'vote-' + id;
          const selected = String(votes[id] ?? '');
          document.querySelectorAll(`input[name="${CSS.escape(name)}"]`).forEach(inp => { inp.checked = (inp.value === selected); });
          if (lbRate.dataset.forId === id) lbRate.querySelectorAll('input[type=radio]').forEach(inp => { inp.checked = (inp.value === selected); });
        }

        function buildRateControls(container, id) {
          container.innerHTML = '';
          container.dataset.forId = id;
          const name = 'vote-' + id;
          const inpy = document.createElement('input'); inpy.type = 'radio'; inpy.name = name; inpy.id = name + '-modal-yes'; inpy.value = 'yes'; if (String(votes[id]) === 'yes') inpy.checked = true;
          const laby = document.createElement('label'); laby.setAttribute('for', inpy.id); laby.textContent = '✓'; laby.title = 'Yes';
          inpy.addEventListener('change', () => setVote(id, 'yes'));
          container.appendChild(inpy); container.appendChild(laby);
          const inpn = document.createElement('input'); inpn.type = 'radio'; inpn.name = name; inpn.id = name + '-modal-no'; inpn.value = 'no'; if (String(votes[id]) === 'no') inpn.checked = true;
          const labn = document.createElement('label'); labn.setAttribute('for', inpn.id); labn.textContent = '✕'; labn.title = 'No';
          inpn.addEventListener('change', () => setVote(id, 'no'));
          container.appendChild(inpn); container.appendChild(labn);
          updateCountsUIForId(id);
        }

        function openModal(idx) {
          if (idx < 0 || idx >= currentItems.length) return;
          currentIndex = idx;
          const p = currentItems[idx];
          lbImg.src = p.url; lbImg.alt = p.filename || p.id;
          lbId.textContent = p.id;
          buildRateControls(lbRate, p.id);
          lb.classList.remove('hidden');
        }
        function closeModal() { lb.classList.add('hidden'); currentIndex = -1; }
        function nav(delta) { if (currentIndex < 0) return; const next = currentIndex + delta; if (next >= 0 && next < currentItems.length) openModal(next); }
        lbClose.addEventListener('click', closeModal);
        lbPrev.addEventListener('click', () => nav(-1));
        lbNext.addEventListener('click', () => nav(1));
        document.addEventListener('keydown', (e) => { if (lb.classList.contains('hidden')) return; if (e.key === 'Escape') closeModal(); else if (e.key === 'ArrowLeft') nav(-1); else if (e.key === 'ArrowRight') nav(1); });

        function render(items) {
          currentItems = items.slice();
          grid.innerHTML = '';
          const frag = document.createDocumentFragment();
          currentItems.forEach((p, i) => {
            const card = document.createElement('article'); card.className = 'card';
            const img = document.createElement('img'); img.loading = 'lazy'; img.decoding = 'async'; img.src = p.url; img.alt = p.filename || p.id; img.addEventListener('click', () => openModal(i));
            card.appendChild(img);

            const meta = document.createElement('div'); meta.className = 'meta';
            const id = document.createElement('div'); id.className = 'id'; id.textContent = p.id; meta.appendChild(id);

            const rate = document.createElement('div'); rate.className = 'rate'; rate.setAttribute('role', 'radiogroup');
            const name = 'vote-' + p.id;
            const inpy = document.createElement('input'); inpy.type = 'radio'; inpy.name = name; inpy.id = name + '-yes'; inpy.value = 'yes'; if (String(votes[p.id]) === 'yes') inpy.checked = true;
            const laby = document.createElement('label'); laby.setAttribute('for', inpy.id); laby.textContent = '✓'; laby.title = 'Yes'; inpy.addEventListener('change', () => setVote(p.id, 'yes'));
            rate.appendChild(inpy); rate.appendChild(laby);
            const inpn = document.createElement('input'); inpn.type = 'radio'; inpn.name = name; inpn.id = name + '-no'; inpn.value = 'no'; if (String(votes[p.id]) === 'no') inpn.checked = true;
            const labn = document.createElement('label'); labn.setAttribute('for', inpn.id); labn.textContent = '✕'; labn.title = 'No'; inpn.addEventListener('change', () => setVote(p.id, 'no'));
            rate.appendChild(inpn); rate.appendChild(labn);
            meta.appendChild(rate);

            const counts = document.createElement('div'); counts.className = 'counts muted'; counts.id = 'counts-grid-' + p.id; counts.textContent = '✓ 0 · ✕ 0'; meta.appendChild(counts);

            card.appendChild(meta);
            frag.appendChild(card);
          });
          grid.appendChild(frag);
          updateProgress();
          fetchCountsFor(currentItems);
          initRemoteSubscription();
          updateCountsUIAll();
        }

        function updateProgress() {
          const total = photos.length;
          const decided = Object.keys(votes).filter(id => isDecided(votes[id])).length;
          progress.textContent = `${decided} decided of ${total}`;
        }

        function buildDecidedList() {
          return photos
            .map(p => ({ photo: p, vote: votes[p.id], counts: getCountsFor(p.id) }))
            .filter(x => isDecided(x.vote));
        }

        function renderResults() {
          const decided = buildDecidedList()
            .sort((a, b) => {
              const ay = a.counts.yes || 0, by = b.counts.yes || 0;
              if (by !== ay) return by - ay; // more YES first
              const an = a.counts.no || 0, bn = b.counts.no || 0;
              if (an !== bn) return an - bn; // fewer NO next
              return a.photo.filename.localeCompare(b.photo.filename);
            });

          resultsGrid.innerHTML = '';
          resultsNote.textContent = decided.length ? `${decided.length} images decided. Yes first.` : 'No votes yet. Please vote with ✓ or ✕.';

          const frag = document.createDocumentFragment();
          for (const { photo: p, vote } of decided) {
            const card = document.createElement('article'); card.className = 'card';
            const img = document.createElement('img'); img.src = p.url; img.alt = p.filename || p.id; img.loading = 'lazy'; img.decoding = 'async';
            img.addEventListener('click', () => { const idx = currentItems.findIndex(ci => ci.id === p.id); if (idx >= 0) openModal(idx); });
            const meta = document.createElement('div'); meta.className = 'meta';
            const title = document.createElement('div'); title.className = 'id'; title.textContent = `${p.id} · ${isYes(vote) ? 'Yes' : 'No'}`; meta.appendChild(title);
            const counts = document.createElement('div'); counts.className = 'counts muted'; counts.id = 'counts-res-' + p.id; counts.textContent = '✓ 0 · ✕ 0'; meta.appendChild(counts);
            card.appendChild(img); card.appendChild(meta);
            frag.appendChild(card);
          }
          resultsGrid.appendChild(frag);
          decided.forEach(({ photo }) => updateCountsUIForId(photo.id));
        }

        function showResults() {
          resultsOpen = true;
          renderResults();
          voteView.classList.add('hidden');
          resultsView.classList.remove('hidden');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        submitBtn.addEventListener('click', showResults);
        resetBtn.addEventListener('click', () => { votes = {}; saveVotes(votes); resultsOpen = false; render(photos); });

        // Initial render
        render(photos);
      })();
    });
  </script>
</body>
</html>
